# References:
# - https://www.olivercoding.com/2019-12-07-github-release-azdevops/

trigger:
 branches:
   include:
     - master
     - releases/*
 tags:
  include:
    - v*

pool:
  vmImage: 'ubuntu-latest'

# See https://github.com/microsoft/azure-pipelines-tasks/issues/11558 for creating the "github" service connection
# 1. Create a personal access token for Azure DevOps to create the service connection. Do this from https://dev.azure.com/rmja/_usersSettings/tokens
# 2. Create a personal access token for Github. Do this from https://github.com/settings/tokens
#    The recommended scopes are: repo, user, admin:repo_hook (see https://dev.azure.com/rmja/Cloudspool/_settings/adminservices)
# AZURE_PAL = "Token obtained from Azure DevOps"
# GITHUB_PAL = "Token obtained from Github"
# 3. Run the following curl command from bash:
# curl -u rmja:AZURE_PAL \
#    -d '{"name": "github-release","type": "github","url": "https://github.com","authorization":{"scheme":"PersonalAccessToken","parameters":{"accessToken":"GITHUB_PAL"}}}' \
#    -H "Content-Type: application/json" \
#    -X POST \
#    'https://dev.azure.com/rmja/Cloudspool/_apis/serviceendpoint/endpoints?api-version=5.1-preview'
steps:
- script: |
    export githubTag=$(git describe --abbrev=0 --tags)
    echo "##vso[task.setvariable variable=githubTag]$githubTag"
  condition: startsWith(variables['Build.SourceBranch'], 'refs/tags/v')
  displayName: Set tag to env variable githubTag
  failOnStderr: true
- task: GithubRelease@0
  condition: startsWith(variables['Build.SourceBranch'], 'refs/tags/v')
  displayName: 'Add assets to GitHub release tag $githubTag'
  inputs:
    gitHubConnection: github-release
    repositoryName: rmja/Cloudspool
    action: edit
    assets: $(Build.ArtifactStagingDirectory)/*
    target: '$(Build.SourceVersion)'
    tag: $githubTag
    addChangeLog: true
    assetUploadMode: replace